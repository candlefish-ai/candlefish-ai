<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Download Debug Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .success { border-color: green; background-color: #f0fff0; }
        .error { border-color: red; background-color: #fff0f0; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; }
        #console-output { background: #f5f5f5; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>PDF Download Debug Test</h1>
    <p>This page will test the exact PDF download functionality from the Candlefish assessment.</p>

    <div class="test-section">
        <h2>Test 1: Basic Blob Download</h2>
        <button onclick="testBasicBlob()">Test Basic Blob Download</button>
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Assessment PDF Download (Exact Copy)</h2>
        <button onclick="testAssessmentPDF()">Test Assessment PDF Download</button>
        <div id="test2-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Browser Compatibility Checks</h2>
        <button onclick="testBrowserCompat()">Check Browser Compatibility</button>
        <div id="test3-result"></div>
    </div>

    <div class="test-section">
        <h2>Console Output</h2>
        <div id="console-output"></div>
        <button onclick="clearConsole()">Clear Console</button>
    </div>

    <script>
        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;

        function logToDiv(message, isError = false) {
            const consoleDiv = document.getElementById('console-output');
            const timestamp = new Date().toTimeString().split(' ')[0];
            const prefix = isError ? '[ERROR]' : '[LOG]';
            consoleDiv.textContent += `${timestamp} ${prefix} ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            logToDiv(args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            logToDiv(args.join(' '), true);
        };

        function clearConsole() {
            document.getElementById('console-output').textContent = '';
        }

        function testBasicBlob() {
            const resultDiv = document.getElementById('test1-result');
            console.log('Testing basic blob download...');

            try {
                const simpleHtml = `
                <!DOCTYPE html>
                <html>
                <head><title>Test PDF</title></head>
                <body><h1>Test Download</h1><p>This is a basic test.</p></body>
                </html>`;

                const blob = new Blob([simpleHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'test-basic.html';

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                resultDiv.innerHTML = '<p style="color: green;">✓ Basic blob download completed successfully</p>';
                console.log('Basic blob test: SUCCESS');
                return true;
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">✗ Basic blob test failed: ${error.message}</p>`;
                console.error('Basic blob test: FAILED -', error);
                return false;
            }
        }

        function testAssessmentPDF() {
            const resultDiv = document.getElementById('test2-result');
            console.log('Testing assessment PDF download (exact copy)...');

            try {
                // Mock results object - same structure as the real assessment
                const results = {
                    overall: {
                        score: 85,
                        level: 'advanced',
                        description: 'Ready for sophisticated automation'
                    },
                    categories: [
                        { name: 'Process Maturity', score: 90, level: 'advanced', recommendations: ['Ready for complex automation workflows'] },
                        { name: 'Technology Readiness', score: 80, level: 'advanced', recommendations: ['Consider AI-powered optimization'] },
                        { name: 'Data Quality', score: 75, level: 'advanced', recommendations: ['Implement predictive analytics'] },
                        { name: 'Change Readiness', score: 95, level: 'advanced', recommendations: ['Ready for sophisticated automation'] }
                    ],
                    nextSteps: [
                        'Schedule a free consultation',
                        'Get a custom implementation roadmap',
                        'Start with a 2-week pilot project'
                    ]
                };

                // EXACT COPY of the PDF generation code from AssessmentForm.tsx (lines 512-563)
                const html = `
                <!DOCTYPE html>
                <html>
                <head>
                  <title>Assessment Report</title>
                  <style>
                    body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; }
                    h1 { color: #0D1B2A; }
                    .score { font-size: 3em; color: #3FD3C6; }
                    .section { margin: 30px 0; padding: 20px; background: #f5f5f5; border-radius: 8px; }
                  </style>
                </head>
                <body>
                  <h1>Candlefish Assessment Report</h1>
                  <div class="section">
                    <h2>Overall Score</h2>
                    <div class="score">${results.overall.score}%</div>
                    <p>Level: ${results.overall.level}</p>
                    <p>${results.overall.description}</p>
                  </div>
                  <div class="section">
                    <h2>Category Scores</h2>
                    ${results.categories.map((cat) => `
                      <div>
                        <h3>${cat.name}</h3>
                        <p>Score: ${cat.score}%</p>
                        <p>Level: ${cat.level}</p>
                      </div>
                    `).join('')}
                  </div>
                  <div class="section">
                    <h2>Next Steps</h2>
                    <ul>
                      ${results.nextSteps.map((step) => `<li>${step}</li>`).join('')}
                    </ul>
                  </div>
                  <p>Generated: ${new Date().toLocaleString()}</p>
                  <p>Contact: hello@candlefish.ai</p>
                </body>
                </html>
                `;

                console.log('Generated HTML length:', html.length);

                const blob = new Blob([html], { type: 'text/html' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `candlefish-assessment-${Date.now()}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                resultDiv.innerHTML = '<p style="color: green;">✓ Assessment PDF download completed successfully</p>';
                console.log('Assessment PDF test: SUCCESS');
                return true;
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">✗ Assessment PDF test failed: ${error.message}</p>`;
                console.error('Assessment PDF test: FAILED -', error);
                return false;
            }
        }

        function testBrowserCompat() {
            const resultDiv = document.getElementById('test3-result');
            console.log('Testing browser compatibility...');

            const tests = [];

            // Test Blob support
            if (typeof Blob !== 'undefined') {
                tests.push('✓ Blob API supported');
                console.log('Blob API: SUPPORTED');
            } else {
                tests.push('✗ Blob API NOT supported');
                console.error('Blob API: NOT SUPPORTED');
            }

            // Test URL.createObjectURL support
            if (typeof URL !== 'undefined' && typeof URL.createObjectURL === 'function') {
                tests.push('✓ URL.createObjectURL supported');
                console.log('URL.createObjectURL: SUPPORTED');
            } else {
                tests.push('✗ URL.createObjectURL NOT supported');
                console.error('URL.createObjectURL: NOT SUPPORTED');
            }

            // Test createElement support
            if (typeof document.createElement === 'function') {
                tests.push('✓ document.createElement supported');
                console.log('document.createElement: SUPPORTED');
            } else {
                tests.push('✗ document.createElement NOT supported');
                console.error('document.createElement: NOT SUPPORTED');
            }

            // Test download attribute support
            const testLink = document.createElement('a');
            if ('download' in testLink) {
                tests.push('✓ download attribute supported');
                console.log('download attribute: SUPPORTED');
            } else {
                tests.push('✗ download attribute NOT supported');
                console.error('download attribute: NOT SUPPORTED');
            }

            // Browser detection
            const userAgent = navigator.userAgent;
            tests.push(`Browser: ${userAgent}`);
            console.log('User Agent:', userAgent);

            resultDiv.innerHTML = '<ul><li>' + tests.join('</li><li>') + '</li></ul>';
            console.log('Browser compatibility check: COMPLETED');
        }

        // Auto-run browser compatibility check on load
        window.addEventListener('load', function() {
            console.log('Page loaded, running initial diagnostics...');
            testBrowserCompat();
        });
    </script>
</body>
</html>

groups:
  - name: paintbox.critical
    rules:
    # High-level service availability
    - alert: ServiceDown
      expr: up{job=~"apollo-router|graphql-subgraphs"} == 0
      for: 1m
      labels:
        severity: critical
        team: platform
      annotations:
        summary: "{{ $labels.job }} service is down"
        description: "Service {{ $labels.job }} on {{ $labels.instance }} has been down for more than 1 minute."
        runbook_url: "https://runbooks.paintbox.candlefish.ai/service-down"

    - alert: HighErrorRate
      expr: |
        (
          rate(apollo_router_http_requests_total{status=~"5.."}[5m]) /
          rate(apollo_router_http_requests_total[5m])
        ) > 0.10
      for: 2m
      labels:
        severity: critical
        team: platform
      annotations:
        summary: "High error rate detected"
        description: "Error rate is {{ $value | humanizePercentage }} for {{ $labels.service_name }}"
        runbook_url: "https://runbooks.paintbox.candlefish.ai/high-error-rate"

    - alert: HighLatency
      expr: |
        histogram_quantile(0.95,
          rate(apollo_router_http_request_duration_seconds_bucket[5m])
        ) > 2
      for: 5m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "High latency detected"
        description: "95th percentile latency is {{ $value }}s for Apollo Router"
        runbook_url: "https://runbooks.paintbox.candlefish.ai/high-latency"

  - name: paintbox.resources
    rules:
    # Resource utilization
    - alert: HighCPUUsage
      expr: |
        (
          rate(container_cpu_usage_seconds_total{container!=""}[5m]) * 100
        ) > 80
      for: 5m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "High CPU usage detected"
        description: "Container {{ $labels.container }} in pod {{ $labels.pod }} is using {{ $value }}% CPU"

    - alert: HighMemoryUsage
      expr: |
        (
          container_memory_usage_bytes{container!=""} /
          container_spec_memory_limit_bytes{container!=""} * 100
        ) > 85
      for: 5m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "High memory usage detected"
        description: "Container {{ $labels.container }} in pod {{ $labels.pod }} is using {{ $value }}% of memory limit"

    - alert: PodCrashLooping
      expr: |
        rate(kube_pod_container_status_restarts_total[15m]) > 0
      for: 5m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "Pod is crash looping"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting frequently"

  - name: paintbox.database
    rules:
    # Database health
    - alert: DatabaseDown
      expr: pg_up == 0
      for: 1m
      labels:
        severity: critical
        team: platform
      annotations:
        summary: "PostgreSQL database is down"
        description: "PostgreSQL database {{ $labels.instance }} is down"
        runbook_url: "https://runbooks.paintbox.candlefish.ai/database-down"

    - alert: HighDatabaseConnections
      expr: |
        (
          pg_stat_database_numbackends / pg_settings_max_connections * 100
        ) > 80
      for: 5m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "High database connection usage"
        description: "Database {{ $labels.datname }} is using {{ $value }}% of max connections"

    - alert: DatabaseLockWaits
      expr: pg_stat_database_conflicts_tablespace > 0
      for: 2m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "Database lock conflicts detected"
        description: "Database {{ $labels.datname }} has {{ $value }} lock conflicts"

  - name: paintbox.redis
    rules:
    # Redis health
    - alert: RedisDown
      expr: redis_up == 0
      for: 1m
      labels:
        severity: critical
        team: platform
      annotations:
        summary: "Redis is down"
        description: "Redis instance {{ $labels.instance }} is down"
        runbook_url: "https://runbooks.paintbox.candlefish.ai/redis-down"

    - alert: RedisHighMemoryUsage
      expr: |
        (
          redis_memory_used_bytes / redis_memory_max_bytes * 100
        ) > 85
      for: 5m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "Redis high memory usage"
        description: "Redis instance {{ $labels.instance }} is using {{ $value }}% of max memory"

    - alert: RedisSlowQueries
      expr: redis_slowlog_length > 100
      for: 5m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "Redis slow queries detected"
        description: "Redis instance {{ $labels.instance }} has {{ $value }} slow queries"

  - name: paintbox.business
    rules:
    # Business metrics
    - alert: LowSuccessfulEstimates
      expr: |
        (
          rate(graphql_resolver_duration_seconds_count{resolver="createEstimate",success="true"}[1h]) /
          rate(graphql_resolver_duration_seconds_count{resolver="createEstimate"}[1h])
        ) < 0.95
      for: 10m
      labels:
        severity: warning
        team: product
      annotations:
        summary: "Low estimate success rate"
        description: "Estimate creation success rate is {{ $value | humanizePercentage }} over the last hour"

    - alert: HighCustomerSyncFailures
      expr: |
        rate(salesforce_sync_failures_total[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        team: integrations
      annotations:
        summary: "High Salesforce sync failure rate"
        description: "Salesforce sync failure rate is {{ $value }} per second"

    - alert: ProjectPhotoUploadFailures
      expr: |
        rate(companycam_upload_failures_total[5m]) > 0.05
      for: 5m
      labels:
        severity: warning
        team: integrations
      annotations:
        summary: "Company Cam photo upload failures"
        description: "Photo upload failure rate is {{ $value }} per second"

  - name: paintbox.external
    rules:
    # External service dependencies
    - alert: SalesforceAPIDown
      expr: |
        probe_success{job="salesforce-api"} == 0
      for: 2m
      labels:
        severity: warning
        team: integrations
      annotations:
        summary: "Salesforce API is unreachable"
        description: "Salesforce API health check has been failing for 2 minutes"

    - alert: CompanyCamAPIDown
      expr: |
        probe_success{job="companycam-api"} == 0
      for: 2m
      labels:
        severity: warning
        team: integrations
      annotations:
        summary: "Company Cam API is unreachable"
        description: "Company Cam API health check has been failing for 2 minutes"

    - alert: ExternalAPIHighLatency
      expr: |
        probe_duration_seconds{job=~"salesforce-api|companycam-api"} > 10
      for: 5m
      labels:
        severity: warning
        team: integrations
      annotations:
        summary: "External API high latency"
        description: "{{ $labels.job }} response time is {{ $value }}s"

  - name: paintbox.security
    rules:
    # Security alerts
    - alert: UnauthorizedAccess
      expr: |
        rate(apollo_router_http_requests_total{status="401"}[5m]) > 0.1
      for: 2m
      labels:
        severity: warning
        team: security
      annotations:
        summary: "High rate of unauthorized requests"
        description: "{{ $value }} unauthorized requests per second detected"

    - alert: RateLimitExceeded
      expr: |
        rate(apollo_router_http_requests_total{status="429"}[5m]) > 1
      for: 1m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "Rate limit exceeded"
        description: "{{ $value }} rate limited requests per second"

    - alert: CertificateExpiration
      expr: |
        probe_ssl_earliest_cert_expiry - time() < 86400 * 7
      for: 0m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "SSL certificate expiring soon"
        description: "SSL certificate for {{ $labels.instance }} expires in {{ $value | humanizeDuration }}"
